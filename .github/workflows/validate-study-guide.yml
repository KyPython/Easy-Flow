name: Validate Study Guide

on:
  push:
    branches: [main, dev]
    paths:
      - 'docs/guides/COMPREHENSIVE_STUDY_GUIDE.md'
      - 'rpa-system/**'
      - 'scripts/validate-study-guide.js'
  pull_request:
    branches: [main, dev]
    paths:
      - 'docs/guides/COMPREHENSIVE_STUDY_GUIDE.md'
      - 'rpa-system/**'
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Validate Study Guide
        id: validate
        continue-on-error: true
        run: |
          chmod +x scripts/validate-study-guide.js
          node scripts/validate-study-guide.js
          exit_code=$?
          if [ $exit_code -ne 0 ]; then
            echo "validation_failed=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "validation_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR (if validation failed)
        if: github.event_name == 'pull_request' && steps.validate.outputs.validation_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Study Guide Validation Failed**\n\nThe study guide does not match the codebase. Please update `docs/guides/COMPREHENSIVE_STUDY_GUIDE.md` to reflect the current implementation.\n\nRun `node scripts/validate-study-guide.js` locally to see detailed errors.'
            })

      - name: Fail job if validation failed
        if: steps.validate.outputs.validation_failed == 'true'
        run: |
          echo "❌ Study Guide validation failed. Please update the study guide to match the codebase."
          exit 1
