name: Auto-Fix Code Formatting (Branch-Aware)

on:
  push:
    branches: [main]  # Only auto-fix on main (dev runs on schedule)
  pull_request:
    branches: [main, dev]  # Run on PRs
  schedule:
    - cron: "0 1 * * *" # Daily at 1 AM UTC (before other checks)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    env:
      CI: true
      NODE_ENV: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            rpa-system/package-lock.json
            rpa-system/rpa-dashboard/package-lock.json
            rpa-system/backend/package-lock.json

      - name: Determine branch and validation mode
        id: branch-info
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "mode=strict" >> $GITHUB_OUTPUT
            echo "blocking=true" >> $GITHUB_OUTPUT
          else
            echo "branch=dev" >> $GITHUB_OUTPUT
            echo "mode=permissive" >> $GITHUB_OUTPUT
            echo "blocking=false" >> $GITHUB_OUTPUT
          fi
          echo "üîç Branch: ${{ steps.branch-info.outputs.branch }}"
          echo "üîç Mode: ${{ steps.branch-info.outputs.mode }}"
          echo "üîç Blocking: ${{ steps.branch-info.outputs.blocking }}"

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Install dependencies
        run: |
          npm ci --silent || true
          cd rpa-system/rpa-dashboard && npm ci --silent || true
          cd ../backend && npm ci --silent || true

      - name: Auto-fix ESLint (Frontend)
        run: |
          if [ -f "rpa-system/rpa-dashboard/package.json" ]; then
            cd rpa-system/rpa-dashboard
            if grep -q '"lint"' package.json || grep -q '"lint:fix"' package.json; then
              echo "üîß Running ESLint auto-fix on frontend..."
              npm run lint:fix 2>/dev/null || npx eslint . --ext .js,.jsx --fix 2>/dev/null || echo "‚ö†Ô∏è ESLint fix not available"
            fi
            cd ../..
          fi
        continue-on-error: true

      - name: Auto-fix ESLint (Backend)
        run: |
          if [ -f "rpa-system/backend/package.json" ]; then
            cd rpa-system/backend
            if grep -q '"lint"' package.json || grep -q '"lint:fix"' package.json; then
              echo "üîß Running ESLint auto-fix on backend..."
              # Run multiple times to catch cascading fixes
              for i in 1 2 3; do
                npm run lint:fix 2>&1 | tee /tmp/lint-output.log
                if ! grep -q "error\|Error" /tmp/lint-output.log; then
                  echo "‚úÖ ESLint fixes complete after $i pass(es)"
                  break
                fi
                echo "üîÑ Running ESLint fix pass $i/3..."
              done || npx eslint . --ext .js --fix 2>/dev/null || echo "‚ö†Ô∏è ESLint fix not available"
            fi
            cd ../..
          fi
        continue-on-error: true

      - name: Auto-format Terraform
        run: |
          if [ -d "infrastructure" ] && command -v terraform >/dev/null 2>&1; then
            echo "üîß Auto-formatting Terraform files..."
            find infrastructure -name "*.tf" -o -name "*.tfvars" | while read file; do
              terraform fmt "$file" 2>/dev/null || true
            done
          else
            echo "‚óã No Terraform files or terraform not installed, skipping"
          fi
        continue-on-error: true

      - name: Auto-format Shell Scripts
        run: |
          if command -v shfmt >/dev/null 2>&1; then
            echo "üîß Auto-formatting shell scripts..."
            find scripts -name "*.sh" -type f | while read file; do
              shfmt -w "$file" 2>/dev/null || true
            done
          else
            echo "‚óã shfmt not installed, skipping shell script formatting"
          fi
        continue-on-error: true

      - name: Check for changes
        id: changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No formatting changes needed"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üìù Formatting changes detected"
            git diff --staged --stat
          fi

      - name: Commit fixes
        if: steps.changes.outputs.changed == 'true'
        run: |
          git commit -m "üîß Auto-fix: Format code (ESLint, Terraform, Shell scripts)

          - Auto-fixed ESLint issues
          - Auto-formatted Terraform files
          - Auto-formatted shell scripts
          
          [skip ci]" || exit 0

      - name: Push fixes
        if: steps.changes.outputs.changed == 'true'
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, push to the PR branch
            git push origin HEAD:${{ github.head_ref }} || echo "‚ö†Ô∏è Could not push fixes (may need manual merge)"
          else
            # For pushes, push directly to the branch
            git push origin ${{ github.ref_name }} || echo "‚ö†Ô∏è Could not push fixes"
          fi

      - name: Comment on PR
        if: steps.changes.outputs.changed == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **Auto-fix applied!**\n\nI\'ve automatically fixed formatting issues:\n- ESLint auto-fixes\n- Terraform formatting\n- Shell script formatting\n\nThe changes have been committed to this PR.'
            })
