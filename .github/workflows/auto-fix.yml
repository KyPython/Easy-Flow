name: Auto-Fix Code Formatting

on:
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            rpa-system/package-lock.json
            rpa-system/rpa-dashboard/package-lock.json
            rpa-system/backend/package-lock.json

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Install dependencies
        run: |
          npm ci --silent || true
          cd rpa-system/rpa-dashboard && npm ci --silent || true
          cd ../backend && npm ci --silent || true

      - name: Auto-fix ESLint (Frontend)
        run: |
          if [ -f "rpa-system/rpa-dashboard/package.json" ]; then
            cd rpa-system/rpa-dashboard
            if grep -q '"lint"' package.json || grep -q '"lint:fix"' package.json; then
              echo "üîß Running ESLint auto-fix on frontend..."
              npm run lint:fix 2>/dev/null || npx eslint . --ext .js,.jsx --fix 2>/dev/null || echo "‚ö†Ô∏è ESLint fix not available"
            fi
            cd ../..
          fi
        continue-on-error: true

      - name: Auto-fix ESLint (Backend)
        run: |
          if [ -f "rpa-system/backend/package.json" ]; then
            cd rpa-system/backend
            if grep -q '"lint"' package.json || grep -q '"lint:fix"' package.json; then
              echo "üîß Running ESLint auto-fix on backend..."
              npm run lint:fix 2>/dev/null || npx eslint . --ext .js --fix 2>/dev/null || echo "‚ö†Ô∏è ESLint fix not available"
            fi
            cd ../..
          fi
        continue-on-error: true

      - name: Auto-format Terraform
        run: |
          if [ -d "infrastructure" ] && command -v terraform >/dev/null 2>&1; then
            echo "üîß Auto-formatting Terraform files..."
            find infrastructure -name "*.tf" -o -name "*.tfvars" | while read file; do
              terraform fmt "$file" 2>/dev/null || true
            done
          else
            echo "‚óã No Terraform files or terraform not installed, skipping"
          fi
        continue-on-error: true

      - name: Auto-format Shell Scripts
        run: |
          if command -v shfmt >/dev/null 2>&1; then
            echo "üîß Auto-formatting shell scripts..."
            find scripts -name "*.sh" -type f | while read file; do
              shfmt -w "$file" 2>/dev/null || true
            done
          else
            echo "‚óã shfmt not installed, skipping shell script formatting"
          fi
        continue-on-error: true

      - name: Check for changes
        id: changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No formatting changes needed"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üìù Formatting changes detected"
            git diff --staged --stat
          fi

      - name: Commit fixes
        if: steps.changes.outputs.changed == 'true'
        run: |
          git commit -m "üîß Auto-fix: Format code (ESLint, Terraform, Shell scripts)

          - Auto-fixed ESLint issues
          - Auto-formatted Terraform files
          - Auto-formatted shell scripts
          
          [skip ci]" || exit 0

      - name: Push fixes
        if: steps.changes.outputs.changed == 'true'
        run: |
          git push origin HEAD:${{ github.head_ref }} || echo "‚ö†Ô∏è Could not push fixes (may need manual merge)"

      - name: Comment on PR
        if: steps.changes.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **Auto-fix applied!**\n\nI\'ve automatically fixed formatting issues:\n- ESLint auto-fixes\n- Terraform formatting\n- Shell script formatting\n\nThe changes have been committed to this PR.'
            })

