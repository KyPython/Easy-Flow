name: Assess Feature Readiness (Branch-Aware)

on:
  workflow_dispatch:
    inputs:
      auto_ship:
        description: 'Auto-ship ready features to production'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # Run daily at 9 AM UTC to assess features
    - cron: '0 9 * * *'
  push:
    branches: [dev]
    paths:
      - 'scripts/assess-feature-readiness.sh'
      - 'scripts/ship-features.sh'
      - '.github/workflows/assess-features.yml'

jobs:
  assess-features:
    runs-on: ubuntu-latest
    env:
      CI: true
      NODE_ENV: development
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for feature detection

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Determine branch and validation mode
        id: branch-info
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "mode=strict" >> $GITHUB_OUTPUT
            echo "blocking=true" >> $GITHUB_OUTPUT
          else
            echo "branch=dev" >> $GITHUB_OUTPUT
            echo "mode=permissive" >> $GITHUB_OUTPUT
            echo "blocking=false" >> $GITHUB_OUTPUT
          fi
          echo "ğŸ” Branch: ${{ steps.branch-info.outputs.branch }}"
          echo "ğŸ” Mode: ${{ steps.branch-info.outputs.mode }}"
          echo "ğŸ” Blocking: ${{ steps.branch-info.outputs.blocking }}"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Make scripts executable
        run: |
          chmod +x scripts/assess-feature-readiness.sh
          chmod +x scripts/ship-features.sh

      - name: Assess feature readiness
        id: assess
        run: |
          echo "ğŸ” Assessing feature readiness..."
          ./scripts/assess-feature-readiness.sh || true
          
          # Read results from manifest
          if [ -f ".features/features.json" ]; then
            READY_COUNT=$(jq '[.[] | select(.status == "ready")] | length' .features/features.json || echo "0")
            NOT_READY_COUNT=$(jq '[.[] | select(.status == "draft")] | length' .features/features.json || echo "0")
            SHIPPED_COUNT=$(jq '[.[] | select(.status == "shipped")] | length' .features/features.json || echo "0")
            
            echo "ready_count=$READY_COUNT" >> $GITHUB_OUTPUT
            echo "not_ready_count=$NOT_READY_COUNT" >> $GITHUB_OUTPUT
            echo "shipped_count=$SHIPPED_COUNT" >> $GITHUB_OUTPUT
            
            # Get ready feature names
            READY_FEATURES=$(jq -r '[.[] | select(.status == "ready") | .name] | join(", ")' .features/features.json || echo "")
            echo "ready_features=$READY_FEATURES" >> $GITHUB_OUTPUT
          else
            echo "ready_count=0" >> $GITHUB_OUTPUT
            echo "not_ready_count=0" >> $GITHUB_OUTPUT
            echo "shipped_count=0" >> $GITHUB_OUTPUT
            echo "ready_features=" >> $GITHUB_OUTPUT
          fi

      - name: Upload feature manifest
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: feature-manifest
          path: .features/
          retention-days: 90

      - name: Generate assessment summary
        if: always()
        run: |
          echo "## Feature Readiness Assessment" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ steps.branch-info.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Mode**: ${{ steps.branch-info.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Ready**: ${{ steps.assess.outputs.ready_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ **Draft**: ${{ steps.assess.outputs.not_ready_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸš€ **Shipped**: ${{ steps.assess.outputs.shipped_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.assess.outputs.ready_count }}" != "0" ]; then
            echo "### Ready Features" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.assess.outputs.ready_features }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ’¡ **Next Steps**: Run \`npm run ship:features\` to ship ready features to production" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Auto-ship ready features (if enabled)
        if: github.event.inputs.auto_ship == 'true' && steps.assess.outputs.ready_count != '0'
        run: |
          echo "ğŸš€ Auto-shipping ready features..."
          ./scripts/ship-features.sh || echo "âš ï¸ Auto-ship failed (non-blocking)"
