name: Code Validation â€” SRP, Dynamic, Theme, Logging (Branch-Aware)

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0  # Full history needed for git diff in PR context

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            rpa-system/package-lock.json
            rpa-system/rpa-dashboard/package-lock.json
            rpa-system/backend/package-lock.json

      - name: Determine branch and validation mode
        id: branch-info
        run: |
          # Strict mode for main branch and PRs targeting main
          # Scripts handle scoping to changed files only in PR context
          if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.base_ref }}" == "main" ]; then
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "mode=strict" >> $GITHUB_OUTPUT
            echo "blocking=true" >> $GITHUB_OUTPUT
          else
            echo "branch=dev" >> $GITHUB_OUTPUT
            echo "mode=permissive" >> $GITHUB_OUTPUT
            echo "blocking=false" >> $GITHUB_OUTPUT
          fi
          echo "ðŸ” Branch: ${{ steps.branch-info.outputs.branch }}"
          echo "ðŸ” Mode: ${{ steps.branch-info.outputs.mode }}"
          echo "ðŸ” Blocking: ${{ steps.branch-info.outputs.blocking }}"

      - name: Make validation scripts executable
        run: |
          chmod +x scripts/validate-all.sh
          chmod +x scripts/validate-srp.sh
          chmod +x scripts/validate-dynamic-code.sh
          chmod +x scripts/validate-theme-consistency.sh
          chmod +x scripts/validate-logging-integration.sh
          chmod +x scripts/validate-env-aware-messages.sh
          chmod +x scripts/validate-rag-knowledge.sh
          chmod +x scripts/validate-learning-system.sh
          chmod +x scripts/validate-duplicate-code.sh
          chmod +x scripts/validate-unused-code.sh
          chmod +x scripts/validate-duplicate-features.sh
          chmod +x scripts/validate-duplicate-cicd.sh
          chmod +x scripts/verify-backup.sh
          chmod +x scripts/validate-test-coverage.sh
          chmod +x scripts/validate-ui-backend-parity.sh

      - name: Run Single Responsibility Principle (SRP) Validation
        run: |
          echo "ðŸ” Checking files, methods, functions, and documentation for SRP compliance..."
          if [ "${{ steps.branch-info.outputs.blocking }}" == "true" ]; then
            ./scripts/validate-srp.sh || (echo "âŒ SRP validation failed" && exit 1)
          else
            ./scripts/validate-srp.sh || echo "âš ï¸ SRP validation issues found (non-blocking on dev branch)"
          fi
        continue-on-error: ${{ steps.branch-info.outputs.blocking != 'true' }}

      - name: Run Dynamic Code Validation
        run: |
          echo "ðŸ” Checking for hardcoded values and ensuring code is dynamic..."
          if [ "${{ steps.branch-info.outputs.blocking }}" == "true" ]; then
            ./scripts/validate-dynamic-code.sh || (echo "âŒ Dynamic code validation failed" && exit 1)
          else
            ./scripts/validate-dynamic-code.sh || echo "âš ï¸ Dynamic code validation issues found (non-blocking on dev branch)"
          fi
        continue-on-error: ${{ steps.branch-info.outputs.blocking != 'true' }}

      - name: Run Theme Consistency Validation
        run: |
          echo "ðŸ” Checking React components for theme usage and consistency..."
          if [ "${{ steps.branch-info.outputs.blocking }}" == "true" ]; then
            ./scripts/validate-theme-consistency.sh || (echo "âŒ Theme consistency validation failed" && exit 1)
          else
            ./scripts/validate-theme-consistency.sh || echo "âš ï¸ Theme consistency validation issues found (non-blocking on dev branch)"
          fi
        continue-on-error: ${{ steps.branch-info.outputs.blocking != 'true' }}

      - name: Run Logging Integration Validation
        run: |
          echo "ðŸ” Checking that all logs use the observability system..."
          if [ "${{ steps.branch-info.outputs.blocking }}" == "true" ]; then
            ./scripts/validate-logging-integration.sh || (echo "âŒ Logging integration validation failed" && exit 1)
          else
            ./scripts/validate-logging-integration.sh || echo "âš ï¸ Logging integration validation issues found (non-blocking on dev branch)"
          fi
        continue-on-error: ${{ steps.branch-info.outputs.blocking != 'true' }}

      - name: Run Environment-Aware Messages Validation
        run: |
          echo "ðŸ” Checking that all user-facing messages are environment-aware..."
          if [ "${{ steps.branch-info.outputs.blocking }}" == "true" ]; then
            ./scripts/validate-env-aware-messages.sh || (echo "âŒ Environment-aware messages validation failed" && exit 1)
          else
            ./scripts/validate-env-aware-messages.sh || echo "âš ï¸ Environment-aware messages validation issues found (non-blocking on dev branch)"
          fi
        continue-on-error: ${{ steps.branch-info.outputs.blocking != 'true' }}

      - name: Run RAG Knowledge Validation
        run: |
          echo "ðŸ” Checking RAG knowledge is up-to-date..."
          if [ "${{ steps.branch-info.outputs.blocking }}" == "true" ]; then
            ./scripts/validate-rag-knowledge.sh || (echo "âŒ RAG knowledge validation failed" && exit 1)
          else
            ./scripts/validate-rag-knowledge.sh || echo "âš ï¸ RAG knowledge may be outdated (non-blocking on dev branch)"
          fi
        continue-on-error: ${{ steps.branch-info.outputs.blocking != 'true' }}

      - name: Run Learning System Validation
        run: |
          echo "ðŸ§  Checking that the app learns from every automation and workflow..."
          if [ "${{ steps.branch-info.outputs.blocking }}" == "true" ]; then
            ./scripts/validate-learning-system.sh || (echo "âŒ Learning system validation failed" && exit 1)
          else
            ./scripts/validate-learning-system.sh || echo "âš ï¸ Learning system issues found (non-blocking on dev branch)"
          fi
        continue-on-error: ${{ steps.branch-info.outputs.blocking != 'true' }}

      - name: Validate Duplicate Code
        env:
          STRICT_MODE: ${{ steps.branch-info.outputs.blocking == 'true' && 'true' || 'false' }}
        run: |
          echo "ðŸ” Checking for duplicate code blocks..."
          chmod +x scripts/validate-duplicate-code.sh
          if [ "${{ steps.branch-info.outputs.blocking }}" == "true" ]; then
            ./scripts/validate-duplicate-code.sh || (echo "âŒ Duplicate code validation failed" && exit 1)
          else
            ./scripts/validate-duplicate-code.sh || echo "âš ï¸ Duplicate code detected (non-blocking on dev branch)"
          fi
        continue-on-error: ${{ steps.branch-info.outputs.blocking != 'true' }}

      - name: Validate Unused Code
        env:
          STRICT_MODE: ${{ steps.branch-info.outputs.blocking == 'true' && 'true' || 'false' }}
        run: |
          echo "ðŸ” Checking for unused code (imports, variables, exports)..."
          chmod +x scripts/validate-unused-code.sh
          if [ "${{ steps.branch-info.outputs.blocking }}" == "true" ]; then
            ./scripts/validate-unused-code.sh || (echo "âŒ Unused code validation failed" && exit 1)
          else
            ./scripts/validate-unused-code.sh || echo "âš ï¸ Unused code detected (non-blocking on dev branch)"
          fi
        continue-on-error: ${{ steps.branch-info.outputs.blocking != 'true' }}

      - name: Validate Duplicate Features
        env:
          STRICT_MODE: ${{ steps.branch-info.outputs.blocking == 'true' && 'true' || 'false' }}
        run: |
          echo "ðŸ” Checking for duplicate features (routes, components, utilities)..."
          chmod +x scripts/validate-duplicate-features.sh
          if [ "${{ steps.branch-info.outputs.blocking }}" == "true" ]; then
            ./scripts/validate-duplicate-features.sh || (echo "âŒ Duplicate features validation failed" && exit 1)
          else
            ./scripts/validate-duplicate-features.sh || echo "âš ï¸ Duplicate features detected (non-blocking on dev branch)"
          fi
        continue-on-error: ${{ steps.branch-info.outputs.blocking != 'true' }}

      - name: Validate Duplicate CI/CD Workflows
        env:
          STRICT_MODE: ${{ steps.branch-info.outputs.blocking == 'true' && 'true' || 'false' }}
        run: |
          echo "ðŸ” Checking for duplicate CI/CD workflows..."
          chmod +x scripts/validate-duplicate-cicd.sh
          if [ "${{ steps.branch-info.outputs.blocking }}" == "true" ]; then
            ./scripts/validate-duplicate-cicd.sh || (echo "âŒ Duplicate CI/CD workflows validation failed" && exit 1)
          else
            ./scripts/validate-duplicate-cicd.sh || echo "âš ï¸ Duplicate CI/CD workflows detected (non-blocking on dev branch)"
          fi
        continue-on-error: ${{ steps.branch-info.outputs.blocking != 'true' }}

      - name: Verify Code Backup (GitHub Repository)
        run: |
          echo "ðŸ’¾ Verifying code is backed up to GitHub..."
          chmod +x scripts/verify-backup.sh
          # Only check GitHub remote and critical files (skip unpushed commits check in CI)
          if git remote -v | grep -q "github.com"; then
            echo "âœ… GitHub remote configured"
          else
            echo "âŒ No GitHub remote found - code is not backed up!"
            exit 1
          fi
          
          # Check critical files exist in git
          CRITICAL_FILES=(
            "render.yaml"
            "docker-compose.yml"
            ".github/workflows"
          )
          
          MISSING=0
          for file in "${CRITICAL_FILES[@]}"; do
            if ! git ls-files --error-unmatch "$file" >/dev/null 2>&1; then
              echo "âŒ Critical file missing from git: $file"
              MISSING=1
            fi
          done
          
          if [ $MISSING -eq 0 ]; then
            echo "âœ… All critical files are in git"
          else
            echo "âŒ Some critical files are missing from git!"
            exit 1
          fi
          
          # Security: Check .env files are NOT in git
          if git ls-files | grep -q "\.env$"; then
            echo "âŒ .env files found in git! This is a security risk."
            exit 1
          else
            echo "âœ… No .env files in git (secure)"
          fi
          
          echo "âœ… Code backup verification passed - code is safe in GitHub"

      - name: Validate Test Coverage
        env:
          STRICT_MODE: ${{ steps.branch-info.outputs.blocking == 'true' && 'true' || 'false' }}
        run: |
          echo "ðŸ§ª Checking test coverage for all code..."
          chmod +x scripts/validate-test-coverage.sh
          if [ "${{ steps.branch-info.outputs.blocking }}" == "true" ]; then
            ./scripts/validate-test-coverage.sh || (echo "âŒ Test coverage validation failed" && exit 1)
          else
            ./scripts/validate-test-coverage.sh || echo "âš ï¸ Test coverage thresholds not met (non-blocking on dev branch)"
          fi
        continue-on-error: ${{ steps.branch-info.outputs.blocking != 'true' }}

      - name: Validate UI/Backend Feature Parity
        env:
          STRICT_MODE: ${{ steps.branch-info.outputs.blocking == 'true' && 'true' || 'false' }}
        run: |
          echo "ðŸ” Checking UI/Backend feature parity..."
          chmod +x scripts/validate-ui-backend-parity.sh
          if [ "${{ steps.branch-info.outputs.blocking }}" == "true" ]; then
            ./scripts/validate-ui-backend-parity.sh || (echo "âŒ UI/Backend feature parity validation failed" && exit 1)
          else
            ./scripts/validate-ui-backend-parity.sh || echo "âš ï¸ UI/Backend feature parity issues found (non-blocking on dev branch)"
          fi
        continue-on-error: ${{ steps.branch-info.outputs.blocking != 'true' }}

      - name: Validate Study Guide
        env:
          STRICT_MODE: ${{ steps.branch-info.outputs.blocking == 'true' && 'true' || 'false' }}
        run: |
          echo "ðŸ“š Checking that study guide matches codebase..."
          chmod +x scripts/validate-study-guide.js
          if [ "${{ steps.branch-info.outputs.blocking }}" == "true" ]; then
            node scripts/validate-study-guide.js || (echo "âŒ Study guide validation failed" && exit 1)
          else
            node scripts/validate-study-guide.js || echo "âš ï¸ Study guide may need updates (non-blocking on dev branch)"
          fi
        continue-on-error: ${{ steps.branch-info.outputs.blocking != 'true' }}

      - name: Validation Summary
        if: always()
        run: |
          echo "## Code Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ steps.branch-info.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Mode**: ${{ steps.branch-info.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.branch-info.outputs.blocking }}" == "true" ]; then
            echo "**Status**: Strict validation - failures block merge" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status**: Permissive validation - warnings only" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All validation checks must pass before code can be shipped to production:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Single Responsibility Principle (SRP)**: Files, methods, functions, and docs follow SRP" >> $GITHUB_STEP_SUMMARY
          echo "- **Dynamic Code**: Code uses environment variables and configuration (not hardcoded)" >> $GITHUB_STEP_SUMMARY
          echo "- **Theme Consistency**: All React components use ThemeContext and CSS variables" >> $GITHUB_STEP_SUMMARY
          echo "- **Logging Integration**: All logs use structured logging and observability system" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment-Aware Messages**: All user-facing messages use getEnvMessage() for dev/prod differentiation" >> $GITHUB_STEP_SUMMARY
          echo "- **RAG Knowledge**: RAG knowledge base is up-to-date with latest features" >> $GITHUB_STEP_SUMMARY
          echo "- **Learning System**: App learns from every automation and workflow execution" >> $GITHUB_STEP_SUMMARY
          echo "- **Duplicate Code**: No duplicate code blocks (threshold: 3%)" >> $GITHUB_STEP_SUMMARY
          echo "- **Unused Code**: No unused imports, variables, or exports" >> $GITHUB_STEP_SUMMARY
          echo "- **Duplicate Features**: No duplicate routes, components, or utilities" >> $GITHUB_STEP_SUMMARY
          echo "- **Duplicate CI/CD Workflows**: No duplicate workflow files, job names, or triggers" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Backup**: All code is backed up to GitHub repository" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Coverage**: All code has adequate test coverage (thresholds: Lines 80%, Functions 70%, Branches 70%, Statements 80%)" >> $GITHUB_STEP_SUMMARY
          echo "- **UI/Backend Feature Parity**: Backend API endpoints have corresponding UI implementations, frontend calls reference existing endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- **Study Guide**: docs/guides/COMPREHENSIVE_STUDY_GUIDE.md matches actual codebase implementation" >> $GITHUB_STEP_SUMMARY

