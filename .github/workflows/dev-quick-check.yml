name: Dev Branch ‚Äî Quick Check (Non-Blocking)

on:
  push:
    branches: [dev]
    # Skip on large file changes to avoid timeouts
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '**.log'
      - 'node_modules/**'
  workflow_dispatch:

# This workflow is intentionally lightweight - just verify code compiles
# Full checks run on schedule and PRs, not blocking dev pushes

jobs:
  quick-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Fast timeout - should complete in 2-3 minutes
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 1  # Shallow clone for speed

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            rpa-system/package-lock.json
            rpa-system/rpa-dashboard/package-lock.json
            rpa-system/backend/package-lock.json

      - name: Install dashboard dependencies
        if: hashFiles('rpa-system/rpa-dashboard/package.json') != ''
        working-directory: rpa-system/rpa-dashboard
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi

      - name: Backend syntax validation (BLOCKING)
        run: |
          echo "üîç Running backend syntax validation..."
          if [ -d "rpa-system/backend" ]; then
            ERRORS=0
            TOTAL=0
            
            # Check all .js files recursively, excluding node_modules and coverage
            while IFS= read -r file; do
              TOTAL=$((TOTAL + 1))
              if ! node --check "$file" 2>&1; then
                echo "‚ùå Syntax error in: $file"
                ERRORS=$((ERRORS + 1))
              fi
            done < <(find rpa-system/backend -type f -name "*.js" ! -path "*/node_modules/*" ! -path "*/coverage/*")
            
            echo ""
            echo "üìä Checked $TOTAL files"
            
            if [ $ERRORS -gt 0 ]; then
              echo "‚ùå Found $ERRORS file(s) with syntax errors"
              echo "ACTION: Fix syntax errors before pushing"
              exit 1
            fi
            
            echo "‚úÖ Backend syntax validation passed"
          fi
        continue-on-error: false

      - name: Verify builds compile
        run: |
          echo "üîç Quick build verification (non-blocking)"
          # Frontend build check (skip if no changes)
          if [ -f "rpa-system/rpa-dashboard/package.json" ]; then
            cd rpa-system/rpa-dashboard
            timeout 120 npm run build 2>&1 | head -50 || echo "‚ö†Ô∏è Build failed. ACTION: Run 'npm run build' in rpa-dashboard locally to fix."
            cd ../..
          fi
        continue-on-error: true

      - name: Success
        run: |
          echo "‚úÖ Quick check complete - dev branch push allowed"
          echo "üìù Full validation runs on schedule and PRs (not blocking pushes)"
