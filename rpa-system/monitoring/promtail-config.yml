# Promtail configuration for Docker container log collection
# Collects logs from Docker containers via Docker logging driver
# Extracts trace IDs for Grafana/Tempo integration

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # -----------------------------
  # 1) Docker containers (unchanged)
  # -----------------------------
  - job_name: easyflow-services
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s

    relabel_configs:
      - source_labels: [__meta_docker_container_name]
        regex: '/(.*)'
        target_label: container_name
        replacement: '${1}'

      - source_labels: [__meta_docker_container_name]
        regex: '/(.*)'
        target_label: job
        replacement: '${1}'

      - source_labels: [__meta_docker_container_name]
        regex: '.*(easy-flow-backend|easyflow-backend|rpa-system-backend|/backend$).*'
        target_label: job
        replacement: 'easyflow-backend'

      - source_labels: [__meta_docker_container_name]
        regex: '.*(easy-flow-rpa-dashboard|easyflow-frontend|rpa-dashboard).*'
        target_label: job
        replacement: 'easyflow-frontend'

      - source_labels: [__meta_docker_container_name]
        regex: '.*(easy-flow-automation-worker|automation-worker|automation-service).*'
        target_label: job
        replacement: 'easyflow-automation'

      - source_labels: [job]
        target_label: service
        replacement: '${1}'

      - target_label: environment
        replacement: 'development'

    pipeline_stages:
      - json:
          expressions:
            docker_log: log
            docker_stream: stream
            docker_time: time

      - json:
          source: docker_log
          expressions:
            level: level
            msg: msg
            app_time: time
            app_timestamp: timestamp
            service: service
            logger: logger
            trace_id: trace.traceId
            span_id: trace.spanId
            user_id: trace.userId
            method: trace.method
            path: trace.path
            execution_id: error.execution_id
            workflow_id: error.workflow_id

      - regex:
          expression: '(?P<trace_id_fallback>[0-9a-fA-F]{32})'
          source: msg

      - template:
          source: trace_id
          template: '{{ if .trace_id }}{{ .trace_id }}{{ else if .trace_id_fallback }}{{ .trace_id_fallback }}{{ end }}'

      - labels:
          level:
          logger:
          trace_id:

      - timestamp:
          source: docker_time
          format: RFC3339Nano
          action_on_failure: skip
      - timestamp:
          source: app_timestamp
          format: RFC3339
          action_on_failure: skip
      - timestamp:
          source: app_time
          format: UnixMs
          action_on_failure: skip

      - template:
          source: output
          template: '{{ .docker_log }}{{ if .trace_id }} traceId="{{ .trace_id }}"{{ end }}'

      - output:
          source: output

  # -----------------------------
  # 2) PM2 file logs (FIXED)
  # -----------------------------
  - job_name: easyflow-pm2-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: easyflow-backend
          service: rpa-system-backend
          environment: development
          __path__: /app/logs/backend.log

      - targets:
          - localhost
        labels:
          job: easyflow-backend
          service: rpa-system-backend
          environment: development
          log_type: error
          __path__: /app/logs/backend-error.log

      - targets:
          - localhost
        labels:
          job: easyflow-frontend
          service: rpa-dashboard
          environment: development
          __path__: /app/logs/frontend.log

      - targets:
          - localhost
        labels:
          job: easyflow-frontend
          service: rpa-dashboard
          environment: development
          log_type: error
          __path__: /app/logs/frontend-error.log

      - targets:
          - localhost
        labels:
          job: easyflow-automation
          service: automation-service
          environment: development
          __path__: /app/logs/automation-worker.log

    pipeline_stages:
      # 1) Strip PM2 + process prefix (e.g. "0|easyflow-backend | 2026-01-13 12:37:08: ")
      - regex:
          # number | name | timestamp: JSON
          expression: '^\d+\|[^\|]+\|\s+\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}:\s+(?P<json_line>.*)$'
          source: message

      # 2) Use extracted JSON if regex matched, else keep original
      - template:
          source: message
          template: '{{ if .json_line }}{{ .json_line }}{{ else }}{{ .message }}{{ end }}'

      # 3) Parse JSON (Pino-style)
      - json:
          expressions:
            level: level
            msg: msg
            time: time
            timestamp: timestamp
            service: service
            logger: logger
            trace_id: trace.traceId
            span_id: trace.spanId
            user_id: trace.userId
            method: trace.method
            path: trace.path
            execution_id: error.execution_id
            workflow_id: error.workflow_id
          drop_malformed: false

      # 4) Fallback trace id
      - regex:
          expression: '(?P<trace_id_fallback>[0-9a-fA-F]{32})'
          source: msg

      - template:
          source: trace_id
          template: '{{ if .trace_id }}{{ .trace_id }}{{ else if .trace_id_fallback }}{{ .trace_id_fallback }}{{ end }}'

      # 5) Labels
      - labels:
          level:
          logger:
          trace_id:

      # 6) Timestamps
      - timestamp:
          source: timestamp
          format: RFC3339
          action_on_failure: skip
      - timestamp:
          source: time
          format: UnixMs
          action_on_failure: skip

      # 7) Drop empty lines
      - drop:
          expression: '^\s*$'
          drop_counter_reason: "empty_message_after_timestamp_strip"

      # 8) Final output: use full JSON as the message
      - output:
          source: message