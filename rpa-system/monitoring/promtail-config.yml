# Promtail configuration for log collection
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
# Backend JSON logs
- job_name: easyflow-backend
  static_configs:
  - targets:
      - localhost
    labels:
      job: easyflow-backend
      service: rpa-system-backend
      environment: development
      __path__: /app/logs/backend*.log
  
  pipeline_stages:
  # Parse JSON logs from backend
  - json:
      expressions:
        level: level
        msg: msg
        time: time
        service: service
        logger: logger
        trace_id: trace.traceId
        span_id: trace.spanId
        user_id: trace.userId
        method: trace.method
        path: trace.path
        execution_id: error.execution_id
        workflow_id: error.workflow_id
  - labels:
      level:
      service:
      logger:
  - timestamp:
      source: time
      format: Unix
  - output:
      source: msg

# Frontend logs
- job_name: easyflow-frontend
  static_configs:
  - targets:
      - localhost
    labels:
      job: easyflow-frontend
      service: rpa-system-frontend
      environment: development
      __path__: /app/logs/frontend*.log

# Automation worker logs (Python with prefixes)
- job_name: easyflow-automation
  static_configs:
  - targets:
      - localhost
    labels:
      job: easyflow-automation
      service: automation-worker
      environment: development
      __path__: /app/logs/automation-worker*.log

# Backend error logs
- job_name: easyflow-backend-errors
  static_configs:
  - targets:
      - localhost
    labels:
      job: easyflow-backend-errors
      service: rpa-system-backend
      environment: development
      log_level: error
      __path__: /app/logs/backend-error*.log
  
  pipeline_stages:
  # Parse JSON error logs
  - json:
      expressions:
        level: level
        msg: msg
        time: time
        service: service
        error: error
        stack: stack
  - labels:
      level:
      service:
  - timestamp:
      source: time
      format: Unix
  - output:
      source: msg

# Frontend error logs
- job_name: easyflow-frontend-errors
  static_configs:
  - targets:
      - localhost
    labels:
      job: easyflow-frontend-errors
      service: rpa-system-frontend
      environment: development
      log_level: error
      __path__: /app/logs/frontend-error*.log
  
  pipeline_stages:
  - timestamp:
      source: time
      format: RFC3339
  - output:
      source: msg

# Automation worker logs (Python with prefixes)
- job_name: easyflow-automation
  static_configs:
  - targets:
      - localhost
    labels:
      job: easyflow-automation
      service: automation-worker
      environment: development
      __path__: /app/logs/automation-worker*.log
  
  pipeline_stages:
  # Match lines with [automation] or [automation:err] prefix
  - regex:
      expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}): (?P<content>.*)'
  - labels:
      log_level: info
  - match:
      selector: '{job="easyflow-automation"}'
      stages:
      - regex:
          expression: '.*(?i)(error|exception|failed|traceback).*'
      - labels:
          log_level: error
  - timestamp:
      source: timestamp
      format: '2006-01-02 15:04:05'
  - output:
      source: content

