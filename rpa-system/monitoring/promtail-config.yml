# Promtail configuration for log collection
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
# Backend JSON logs
- job_name: easyflow-backend
  static_configs:
  - targets:
      - localhost
    labels:
      job: easyflow-backend
      service: rpa-system-backend
      environment: development
      __path__: /app/logs/backend.log
  
  pipeline_stages:
  # Parse JSON logs from backend
  - json:
      expressions:
        level: level
        msg: msg
        time: time
        service: service
        logger: logger
        trace_id: trace.traceId
        span_id: trace.spanId
        user_id: trace.userId
        method: trace.method
        path: trace.path
        execution_id: error.execution_id
        workflow_id: error.workflow_id
  - labels:
      level:
      service:
      logger:
  - timestamp:
      source: time
      format: Unix
  - output:
      source: msg

# Frontend logs
- job_name: easyflow-frontend
  static_configs:
  - targets:
      - localhost
    labels:
      job: easyflow-frontend
      service: rpa-system-frontend
      environment: development
      __path__: /app/logs/frontend.log

# Automation worker logs (Python with prefixes)
- job_name: easyflow-automation
  static_configs:
  - targets:
      - localhost
    labels:
      job: easyflow-automation
      service: automation-worker
      environment: development
      __path__: /app/logs/automation-worker.log
  
  pipeline_stages:
  # Match lines with [automation] or [automation:err] prefix
  - match:
      selector: '{job="easyflow-automation"}'
      stages:
      - regex:
          expression: '^\[automation(?P<log_stream>:err)?\] (?P<content>.*)'
      - labels:
          log_stream:
      - output:
          source: content

