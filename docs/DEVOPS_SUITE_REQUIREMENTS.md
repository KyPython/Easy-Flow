# DevOps Suite Requirements
## What the Shell-Games Toolkit Should Generate Automatically

This document outlines the improvements needed in the devops productivity suite (shell-games toolkit) to generate bulletproof, production-ready scripts by default.

## Critical Flaws Fixed Manually (Should Be Auto-Generated)

### 1. Dynamic Port Configuration

**Problem:** Scripts had hardcoded ports (3000, 3030, 7070, etc.)

**Solution Required:**
- Auto-detect ports from environment variables or config files
- Generate port variables with defaults: `PORT=${PORT:-3030}`
- Synchronize ports between start/stop scripts automatically
- Include port validation (numeric check)

**Example Pattern:**
```bash
# Auto-generated by devops suite
FRONTEND_PORT=${FRONTEND_PORT:-3000}
BACKEND_PORT=${PORT:-3030}
AUTOMATION_PORT=${AUTOMATION_PORT:-7070}

# Validate ports are numeric
for port in "$FRONTEND_PORT" "$BACKEND_PORT" "$AUTOMATION_PORT"; do
    if [[ ! "$port" =~ ^[0-9]+$ ]]; then
        echo "Error: Invalid port number: $port"
        exit 1
    fi
done
```

### 2. Dependency Detection & Auto-Installation

**Problem:** Scripts failed when dependencies were missing (e.g., `dotenv` module not found)

**Solution Required:**
- Detect required npm packages before use
- Auto-install missing dependencies
- Verify critical packages exist (not just `node_modules` folder)
- Check for Python packages if Python scripts are involved

**Example Pattern:**
```bash
# Auto-generated dependency check function
check_npm_package() {
    local dir=$1
    local package=$2
    [ -d "$dir/node_modules/$package" ] || return 1
}

# Auto-generated installation logic
if ! check_npm_package "." "dotenv"; then
    echo "Installing dotenv..."
    npm install dotenv --save --silent
fi
```

### 3. Docker Daemon Validation

**Problem:** Scripts attempted Docker operations without checking if Docker daemon is running

**Solution Required:**
- Check `docker info` before any Docker commands
- Provide clear error messages if Docker isn't running
- Skip Docker operations gracefully if daemon unavailable (for stop scripts)

**Example Pattern:**
```bash
# Auto-generated Docker check
if ! docker info > /dev/null 2>&1; then
    echo "Error: Docker daemon is not running"
    echo "Please start Docker Desktop and try again"
    exit 1
fi
```

### 4. Input Sanitization & Security

**Problem:** Scripts used unquoted variables and lacked input validation

**Solution Required:**
- Generate sanitization functions for user input
- Quote all variables automatically
- Validate file paths (prevent directory traversal)
- Validate URLs before use
- Validate port numbers

**Example Pattern:**
```bash
# Auto-generated sanitization functions
sanitize_input() {
    echo "$1" | sed 's/[^a-zA-Z0-9._-]//g'
}

sanitize_path() {
    echo "$1" | sed 's/\.\.//g' | sed 's|^/||'
}

# Auto-quote all variables in generated scripts
CONTAINER_NAME=$(sanitize_input "$CONTAINER_NAME")
LOG_PATH=$(sanitize_path "$LOG_PATH")
```

### 5. Port Synchronization

**Problem:** Start and stop scripts used different port values

**Solution Required:**
- Generate shared port configuration
- Ensure start/stop scripts read from same source
- Use consistent environment variable names

**Example Pattern:**
```bash
# Shared port config (auto-generated in both scripts)
# Load from .env if exists
[ -f .env ] && export $(cat .env | grep -v '^#' | xargs)

# Same defaults in both scripts
FRONTEND_PORT=${FRONTEND_PORT:-3000}
BACKEND_PORT=${PORT:-3030}
```

### 6. Error Handling & Recovery

**Problem:** Scripts failed completely on first error

**Solution Required:**
- Use `set +e` for cleanup scripts (stop scripts)
- Use `set -e` for critical scripts (start scripts)
- Add retry logic for transient failures
- Provide clear error messages with actionable guidance
- **Self-healing:** Automatically detect and fix common issues (e.g., stale Zookeeper nodes, container conflicts)

### 6.1. Container State Management (Kafka/Zookeeper Example)

**Problem:** Containers can get into bad states (stale Zookeeper nodes, NodeExistsException, container conflicts)

**Solution Required:**
- Detect unhealthy containers (not just "running" but actually responding)
- Automatically clean up and restart on failure
- Check logs for specific error patterns (e.g., NodeExistsException)
- Remove containers completely on stop (not just stop, but `rm -f`) to clear state
- Retry with cleanup on health check failures

**Example Pattern:**
```bash
# Auto-generated container health check
check_kafka_health() {
    local container=$(docker compose ps kafka --format json | jq -r '.[0].Name')
    [ -z "$container" ] && return 1
    docker exec "$container" kafka-broker-api-versions --bootstrap-server kafka:29092 >/dev/null 2>&1
}

# Auto-generated cleanup and restart
cleanup_and_restart_kafka() {
    docker compose stop kafka zookeeper 2>/dev/null || true
    docker compose rm -f kafka zookeeper 2>/dev/null || true
    sleep 2
    docker compose up -d kafka zookeeper
}

# Auto-generated self-healing logic
if ! check_kafka_health; then
    # Check logs for specific errors
    if docker logs "$container" 2>&1 | grep -q "NodeExistsException"; then
        cleanup_and_restart_kafka
    fi
fi
```

**Example Pattern:**
```bash
# Auto-generated error handling
set +e  # For cleanup scripts
# ... operations that may fail ...
set -e  # For critical operations

# Auto-generated retry logic
MAX_RETRIES=3
for i in $(seq 1 $MAX_RETRIES); do
    if docker compose up -d; then
        break
    fi
    [ $i -eq $MAX_RETRIES ] && {
        echo "Error: Failed after $MAX_RETRIES attempts"
        exit 1
    }
    sleep 2
done
```

### 7. Environment Variable Loading

**Problem:** Scripts didn't consistently load `.env` files

**Solution Required:**
- Auto-generate `.env` loading at script start
- Handle missing `.env` gracefully
- Export variables for child processes

**Example Pattern:**
```bash
# Auto-generated at top of scripts
if [ -f .env ]; then
    export $(cat .env | grep -v '^#' | xargs)
else
    echo "Warning: No .env file found, using defaults"
fi
```

## Required Auto-Generated Functions

The devops suite should generate these utility functions in every script:

### 1. Input Sanitization
```bash
sanitize_input() { ... }
sanitize_path() { ... }
is_valid_url() { ... }
validate_port() { ... }
```

### 2. Dependency Management
```bash
check_npm_package() { ... }
install_npm_deps() { ... }
check_python_package() { ... }
install_python_deps() { ... }
```

### 3. Service Health Checks
```bash
check_docker_daemon() { ... }
check_port_available() { ... }
wait_for_service() { ... }
```

### 4. Error Handling
```bash
handle_error() { ... }
retry_command() { ... }
cleanup_on_exit() { ... }
```

## Configuration Detection

The devops suite should automatically detect:

1. **Port Configuration:**
   - From `package.json` scripts
   - From environment variables
   - From config files (`.env`, `docker-compose.yml`)
   - From service definitions

2. **Dependencies:**
   - From `package.json` (npm)
   - From `requirements.txt` (Python)
   - From `Dockerfile` (container dependencies)

3. **Service Types:**
   - Node.js services
   - Python services
   - Docker containers
   - PM2 processes

## Template Improvements

### Start Script Template Should Include:
- ✅ Environment variable loading
- ✅ Dependency detection & installation
- ✅ Docker daemon check
- ✅ Port validation & conflict detection
- ✅ Service health checks
- ✅ Error recovery logic

### Stop Script Template Should Include:
- ✅ Environment variable loading (same as start)
- ✅ Docker daemon check (graceful skip)
- ✅ Port cleanup (using same variables as start)
- ✅ Graceful error handling (`set +e`)
- ✅ Process cleanup (PM2, Docker, ports)

### Health Check Script Template Should Include:
- ✅ Service availability checks
- ✅ Port validation
- ✅ Dependency verification
- ✅ Clear status reporting

## Implementation Priority

1. **Critical (Must Have):**
   - Dynamic port configuration
   - Dependency detection
   - Docker daemon checks
   - Input sanitization

2. **Important (Should Have):**
   - Port synchronization
   - Error recovery
   - Environment variable loading

3. **Nice to Have:**
   - Retry logic
   - Advanced health checks
   - Performance monitoring

## Testing Requirements

Generated scripts should be tested for:
- ✅ Works when dependencies are missing (auto-installs)
- ✅ Works when Docker isn't running (graceful handling)
- ✅ Works with custom ports (reads from env)
- ✅ Handles invalid input (sanitization)
- ✅ Start/stop scripts use same ports (synchronization)
- ✅ Fails fast on critical errors (clear messages)

## Summary

The devops suite should generate scripts that are:
- **Bulletproof:** Handle edge cases automatically
- **Secure:** Sanitize input, quote variables, validate data
- **Dynamic:** Read from environment/config, not hardcoded
- **Self-Healing:** Auto-install dependencies, retry failures
- **Consistent:** Start/stop scripts synchronized
- **Production-Ready:** Error handling, logging, validation

All the improvements made manually to `start-dev.sh` and `stop-dev.sh` should be the **default** output of the devops suite.

