#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# EasyFlow Pre-Push Hook
# Runs different checks based on branch:
# - dev branch: Light checks only (allows saving work)
# - main branch: Full strict checks (production safety)

CURRENT_BRANCH=$(git branch --show-current)

if [ "$CURRENT_BRANCH" = "main" ]; then
    echo "üöÄ Running pre-push validation for PRODUCTION (main branch)..."
    echo "‚ö†Ô∏è  Strict checks required for production deployment"
    npm run test:all
    
    # Terraform validation for infrastructure changes
    if git diff origin/main --name-only | grep -q "infrastructure/.*\.tf$" || [ -d "infrastructure" ]; then
        echo "üîç Validating Terraform configuration..."
        if [ -f "infrastructure/main.tf" ]; then
            cd infrastructure
            ../scripts/terraform-validate.sh || (echo "‚ùå Terraform validation failed" && exit 1)
            cd ..
        fi
    fi
elif [ "$CURRENT_BRANCH" = "dev" ]; then
    echo "üíæ Running light pre-push checks for dev branch (work-in-progress)..."
    echo "‚ÑπÔ∏è  Full checks will run when you ship to production (npm run ship)"
    # Only run quick checks, skip full test suite and security scan
    ./scripts/dev-env-check.sh >/dev/null 2>&1 || true
    
    # Quick Terraform format check for dev branch
    if [ -d "infrastructure" ] && [ -f "infrastructure/main.tf" ]; then
        echo "üîç Quick Terraform format check..."
        cd infrastructure
        ../scripts/terraform-fmt.sh --check >/dev/null 2>&1 || echo "‚ö†Ô∏è Terraform files need formatting (run 'npm run infra:fmt')"
        cd ..
    fi
    
    echo "‚úÖ Dev branch push allowed (full checks skipped for faster workflow)"
else
    echo "‚ö†Ô∏è  Unknown branch: $CURRENT_BRANCH"
    echo "Running full checks to be safe..."
    npm run test:all
fi

