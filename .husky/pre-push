#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# EasyFlow Pre-Push Hook
# Runs different checks based on branch:
# - dev branch: Light checks only (allows saving work)
# - main branch: Full strict checks (production safety)

CURRENT_BRANCH=$(git branch --show-current)

if [ "$CURRENT_BRANCH" = "main" ]; then
    echo "‚ùå ERROR: Direct pushes to 'main' branch are BLOCKED for production safety"
    echo ""
    echo "üîí Production deployments must go through the proper workflow:"
    echo "   1. Work on 'dev' branch"
    echo "   2. Run: npm run ship"
    echo "   3. The ship script will:"
    echo "      - Run all tests and validations"
    echo "      - Merge dev ‚Üí main"
    echo "      - Push to main (triggers production deployment)"
    echo ""
    echo "üí° This prevents non-production-ready code from reaching users"
    echo ""
    exit 1
elif [ "$CURRENT_BRANCH" = "dev" ]; then
    echo "üíæ Running light pre-push checks for dev branch (work-in-progress)..."
    echo "‚ÑπÔ∏è  Full checks will run when you ship to production (npm run ship)"
    # Only run quick checks, skip full test suite and security scan
    ./scripts/dev-env-check.sh >/dev/null 2>&1 || true
    
    # Quick Terraform format check (non-dev branches)
    if [ -d "infrastructure" ] && [ -f "infrastructure/main.tf" ]; then
        echo "üîç Quick Terraform format check..."
        repo_root=$(git rev-parse --show-toplevel)
        cd "$repo_root/infrastructure" || exit 0
        ../scripts/terraform-fmt.sh --check >/dev/null 2>&1 || echo "‚ö†Ô∏è Terraform files need formatting (run 'npm run infra:fmt')"
        cd "$repo_root" || true
    fi
    
    echo "‚úÖ Dev branch push allowed (full checks skipped for faster workflow)"
else
    echo "‚ö†Ô∏è  Unknown branch: $CURRENT_BRANCH"
    echo "Running full checks to be safe..."
    npm run test:all
fi

