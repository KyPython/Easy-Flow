#!/usr/bin/env sh

# EasyFlow Pre-Push Hook
# Runs different checks based on branch:
# - dev branch: Quick checks only (fast iteration)
# - main branch: BLOCKED - use npm run ship

CURRENT_BRANCH=$(git branch --show-current)

if [ "$CURRENT_BRANCH" = "main" ]; then
    echo "‚ùå ERROR: Direct pushes to 'main' branch are BLOCKED for production safety"
    echo ""
    echo "üîí Production deployments must go through the proper workflow:"
    echo "   1. Work on 'dev' branch"
    echo "   2. Run: npm run ship"
    echo "   3. The ship script will:"
    echo "      - Run all tests and validations"
    echo "      - Merge dev ‚Üí main"
    echo "      - Push to main (triggers production deployment)"
    echo ""
    echo "üí° This prevents non-production-ready code from reaching users"
    echo ""
    exit 1
elif [ "$CURRENT_BRANCH" = "dev" ]; then
    # Dev branch: fast push by default, full CI runs on GitHub
    echo "üíæ Dev branch push - quick local check, full CI runs on GitHub"
    
    # Only run full local CI if explicitly requested
    if [ "${FULL_CI:-false}" = "true" ]; then
        echo "üß™ FULL_CI=true ‚Üí Running full local CI gate..."
        chmod +x scripts/local-ci-full.sh || true
        ./scripts/local-ci-full.sh
    fi
    
    echo "‚úÖ Dev push allowed"
    exit 0
else
    echo "‚ö†Ô∏è  Unknown branch: $CURRENT_BRANCH"
    echo "Allowing push - CI will validate on GitHub"
    exit 0
fi
