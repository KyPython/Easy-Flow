#!/usr/bin/env sh

# EasyFlow Pre-Push Hook
# Runs different checks based on branch:
# - main branch: BLOCKED (must go through PR)
# - dev branch: Full local CI gate (with FAST_PUSH override)
# - feature branches (fix/*, feat/*, etc.): Light checks, CI will gatekeep

CURRENT_BRANCH=$(git branch --show-current)

if [ "$CURRENT_BRANCH" = "main" ]; then
    echo "âŒ ERROR: Direct pushes to 'main' branch are BLOCKED for production safety"
    echo ""
    echo "ğŸ”’ Production deployments must go through the proper workflow:"
    echo "   1. Work on a feature branch or 'dev' branch"
    echo "   2. Create a PR to main"
    echo "   3. CI must pass before merge"
    echo "   4. Branch protection enforces this"
    echo ""
    echo "ğŸ’¡ This prevents non-production-ready code from reaching users"
    echo ""
    exit 1
elif [ "$CURRENT_BRANCH" = "dev" ]; then
    if [ "${FAST_PUSH:-false}" = "true" ]; then
        echo "ğŸ’¾ FAST_PUSH=true â†’ skipping full local CI gate for dev."
        echo "âš ï¸  CI will run on GitHub; use this only when you intentionally accept slower feedback."
        exit 0
    fi

    echo "ğŸ§ª Running FULL local CI gate for dev (blocks push on failure)..."
    chmod +x scripts/local-ci-full.sh || true
    ./scripts/local-ci-full.sh
    echo "âœ… Dev push allowed (local CI gate passed)"
else
    # Feature branches (fix/*, feat/*, etc.) - run light checks, CI will be the gatekeeper
    echo "ğŸ“‹ Feature branch detected: $CURRENT_BRANCH"
    echo "ğŸ” Running light pre-push checks (CI will run full checks)..."
    
    # Only check that the code builds - CI will run full tests
    echo "  â†’ Verifying frontend builds..."
    if command -v npm >/dev/null 2>&1 && [ -d "rpa-system/rpa-dashboard" ]; then
        (cd rpa-system/rpa-dashboard && npm run build --silent 2>/dev/null) || {
            echo "âŒ Frontend build failed - please fix before pushing"
            exit 1
        }
        echo "  âœ“ Frontend builds successfully"
    fi
    
    echo ""
    echo "âœ… Feature branch push allowed"
    echo "ğŸ“Œ CI will run full tests on GitHub - check PR status before merging"
fi

