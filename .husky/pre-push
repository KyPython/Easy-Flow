#!/usr/bin/env sh

# EasyFlow Pre-Push Hook
# Runs different checks based on branch:
# - dev branch: Light checks only (allows saving work)
# - main branch: Full strict checks (production safety)

CURRENT_BRANCH=$(git branch --show-current)

if [ "$CURRENT_BRANCH" = "main" ]; then
    echo "‚ùå ERROR: Direct pushes to 'main' branch are BLOCKED for production safety"
    echo ""
    echo "üîí Production deployments must go through the proper workflow:"
    echo "   1. Work on 'dev' branch"
    echo "   2. Run: npm run ship"
    echo "   3. The ship script will:"
    echo "      - Run all tests and validations"
    echo "      - Merge dev ‚Üí main"
    echo "      - Push to main (triggers production deployment)"
    echo ""
    echo "üí° This prevents non-production-ready code from reaching users"
    echo ""
    exit 1
elif [ "$CURRENT_BRANCH" = "dev" ]; then
    if [ "${FAST_PUSH:-false}" = "true" ]; then
        echo "üíæ FAST_PUSH=true ‚Üí skipping full local CI gate for dev."
        echo "‚ö†Ô∏è  CI will run on GitHub; use this only when you intentionally accept slower feedback."
        exit 0
    fi

    echo "üß™ Running FULL local CI gate for dev (blocks push on failure)..."
    chmod +x scripts/local-ci-full.sh || true
    ./scripts/local-ci-full.sh
    echo "‚úÖ Dev push allowed (local CI gate passed)"
else
    echo "‚ö†Ô∏è  Unknown branch: $CURRENT_BRANCH"
    echo "Running full checks to be safe..."
    npm run test:all
fi

