#!/bin/bash
# Rebuild Docker containers and provide testing instructions

set -e

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ³ REBUILDING DOCKER CONTAINERS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Check Docker
if ! docker ps > /dev/null 2>&1; then
    echo "âŒ Docker is not running!"
    echo "   Please start Docker Desktop and try again."
    exit 1
fi

echo "âœ… Docker is running"
echo ""

# Stop existing containers
echo "ğŸ›‘ Stopping existing containers..."
docker-compose down || true
echo ""

# Rebuild and start
echo "ğŸ”¨ Rebuilding containers with new configuration..."
echo "   This will:"
echo "   - Rebuild backend with updated .env"
echo "   - Rebuild frontend with updated .env.local"
echo "   - Include firebase-config.js in frontend build"
echo ""

docker-compose up --build -d

echo ""
echo "â³ Waiting for services to start..."
sleep 5

echo ""
echo "ğŸ“Š Container Status:"
docker-compose ps

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… REBUILD COMPLETE"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ§ª TESTING INSTRUCTIONS:"
echo ""
echo "1. Open a NEW Incognito/Private browser window"
echo "   - This ensures clean session, no cached service workers"
echo ""
echo "2. Navigate to: http://localhost:3000"
echo ""
echo "3. Check browser console (F12) for:"
echo "   âœ… Should see: 'Firebase initialized successfully'"
echo "   âœ… Should see: 'Supabase client initialized'"
echo "   âŒ Should NOT see: 401 or 400 errors"
echo ""
echo "4. Check backend logs:"
echo "   docker-compose logs backend | tail -50"
echo ""
echo "5. Check frontend logs:"
echo "   docker-compose logs rpa-dashboard | tail -50"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âš ï¸  IMPORTANT: Backend still needs Firebase credentials"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Before backend will work fully, add Firebase credentials to:"
echo "  rpa-system/backend/.env"
echo ""
echo "See: rpa-system/backend/BACKEND_ENV_SETUP.md"
echo ""
